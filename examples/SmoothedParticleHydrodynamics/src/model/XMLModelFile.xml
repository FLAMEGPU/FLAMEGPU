<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="FLAMEGPU_vcproj.xslt"?>
<gpu:xmodel xmlns:gpu="http://www.dcs.shef.ac.uk/~paul/XMMLGPU" xmlns="http://www.dcs.shef.ac.uk/~paul/XMML">
  <name>Smoothed Particle Hydrodynamics</name>
  <gpu:environment>
    <gpu:constants>
      <gpu:variable>
        <type>float</type>
        <name>TIMESTEP</name>
        <description>How far in time each step of the simulation advances the system in seconds</description>
        <defaultValue>0.001</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>GRAVITY</name>
        <description>The acceleration due to gravity in m/s</description>
        <defaultValue>-9.8</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>FLUID_REST_DENSITY</name>
        <description>The resting density of the fluid in kg/m^3. The simulation parameters are tuned such that a density of 1000 will mean initial particle arrangement is stable.</description>
        <defaultValue>1000.0</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>VISCOSITY</name>
        <description>The viscosity of the fluid.</description>
        <defaultValue>10.0</defaultValue>
      </gpu:variable>
      <gpu:variable>
        <type>float</type>
        <name>PRESSURE_COEFFICIENT</name>
        <description>Describes the compressibility of the fluid.</description>
        <defaultValue>0.9</defaultValue>
      </gpu:variable>
    </gpu:constants>
    <gpu:functionFiles>
      <file>functions.c</file>
    </gpu:functionFiles>
  </gpu:environment>
  <xagents>
    <gpu:xagent>
      <name>FluidParticle</name>
      <description>A particle representing a body of fluid</description>
      <memory>
        <gpu:variable>
          <type>int</type>
          <name>id</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>x</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>y</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>z</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>dx</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>dy</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>dz</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>fx</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>fy</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>fz</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>density</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>pressure</name>
        </gpu:variable>
        <gpu:variable>
          <type>int</type>
          <name>isStatic</name>
        </gpu:variable>
      </memory>
      <functions>
        <gpu:function>
          <name>outputLocation</name>
          <currentState>default</currentState>
          <nextState>default</nextState>
          <outputs>
            <gpu:output>
              <messageName>location</messageName>
              <gpu:type>single_message</gpu:type>
            </gpu:output>
          </outputs>
          <gpu:reallocate>false</gpu:reallocate>
          <gpu:RNG>false</gpu:RNG>
        </gpu:function>
        <gpu:function>
          <name>computeDensityPressure</name>
          <currentState>default</currentState>
          <nextState>default</nextState>
          <inputs>
            <gpu:input>
              <messageName>location</messageName>
            </gpu:input>
          </inputs>
          <outputs>
            <gpu:output>
              <messageName>density_pressure</messageName>
              <gpu:type>single_message</gpu:type>
            </gpu:output>
          </outputs>
          <gpu:reallocate>false</gpu:reallocate>
          <gpu:RNG>false</gpu:RNG>
        </gpu:function>
        <gpu:function>
          <name>computeForce</name>
          <currentState>default</currentState>
          <nextState>default</nextState>
          <inputs>
            <gpu:input>
              <messageName>density_pressure</messageName>
            </gpu:input>
          </inputs>
          <condition>
            <lhs>
              <agentVariable>isStatic</agentVariable>
            </lhs>
            <operator>==</operator>
            <rhs>
              <value>0</value>
            </rhs>
          </condition>
          <gpu:reallocate>false</gpu:reallocate>
        </gpu:function>
        <gpu:function>
          <name>integrate</name>
          <currentState>default</currentState>
          <nextState>default</nextState>
          <condition>
            <lhs>
              <agentVariable>isStatic</agentVariable>
            </lhs>
            <operator>==</operator>
            <rhs>
              <value>0</value>
            </rhs>
          </condition>
          <gpu:reallocate>false</gpu:reallocate>
        </gpu:function>
      </functions>
      <states>
        <gpu:state>
          <name>default</name>
        </gpu:state>
        <gpu:state>
          <name>static</name>
        </gpu:state>
        <initialState>default</initialState>
      </states>
      <gpu:type>continuous</gpu:type>
      <gpu:bufferSize>131072</gpu:bufferSize>
    </gpu:xagent>
  </xagents>
  <messages>
    <gpu:message>
      <name>location</name>
      <description>A message holding the location and velocity of an agent</description>
      <variables>
        <gpu:variable>
          <type>int</type>
          <name>id</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>x</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>y</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>z</name>
        </gpu:variable>
      </variables>
      <gpu:partitioningSpatial>
        <gpu:radius>0.02</gpu:radius>
        <gpu:xmin>-0.5</gpu:xmin>
        <gpu:xmax>0.5</gpu:xmax>
        <gpu:ymin>-0.5</gpu:ymin>
        <gpu:ymax>0.5</gpu:ymax>
        <gpu:zmin>-0.5</gpu:zmin>
        <gpu:zmax>0.5</gpu:zmax>
      </gpu:partitioningSpatial>
      <gpu:bufferSize>131072</gpu:bufferSize>
    </gpu:message>
    <gpu:message>
      <name>density_pressure</name>
      <description>A message holding the density and pressure of an agent</description>
      <variables>
        <gpu:variable>
          <type>int</type>
          <name>id</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>density</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>pressure</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>x</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>y</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>z</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>dx</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>dy</name>
        </gpu:variable>
        <gpu:variable>
          <type>float</type>
          <name>dz</name>
        </gpu:variable>
        <gpu:variable>
          <type>int</type>
          <name>isStatic</name>
        </gpu:variable>
      </variables>
      <gpu:partitioningSpatial>
        <gpu:radius>0.02</gpu:radius>
        <gpu:xmin>-0.5</gpu:xmin>
        <gpu:xmax>0.5</gpu:xmax>
        <gpu:ymin>-0.5</gpu:ymin>
        <gpu:ymax>0.5</gpu:ymax>
        <gpu:zmin>-0.5</gpu:zmin>
        <gpu:zmax>0.5</gpu:zmax>
      </gpu:partitioningSpatial>
      <gpu:bufferSize>131072</gpu:bufferSize>
    </gpu:message>
  </messages>
  <layers>
    <layer>
      <gpu:layerFunction>
        <name>outputLocation</name>
      </gpu:layerFunction>
    </layer>
    <layer>
      <gpu:layerFunction>
        <name>computeDensityPressure</name>
      </gpu:layerFunction>
    </layer>
    <layer>
      <gpu:layerFunction>
        <name>computeForce</name>
      </gpu:layerFunction>
    </layer>
    <layer>
      <gpu:layerFunction>
        <name>integrate</name>
      </gpu:layerFunction>
    </layer>
  </layers>
</gpu:xmodel>
